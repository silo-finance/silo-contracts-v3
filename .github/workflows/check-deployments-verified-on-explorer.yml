# Check deployment contract verification on block explorers.
# Runs whenever deployments change (PR or push to master). Never fails CI.
# Uses matrix for parallel per-chain verification - re-run failed jobs individually.
# Posts/updates a single PR comment with merged results.

name: Code verification

on:
  push:
    branches: [master]
    paths:
      - silo-core/deployments/**
      - silo-core/broadcast/**
      - silo-oracles/deployments/**
      - silo-oracles/broadcast/**
      - silo-vaults/deployments/**
      - silo-vaults/broadcast/**
  pull_request:
    types: [opened, synchronize]
    paths:
      - silo-core/deployments/**
      - silo-core/broadcast/**
      - silo-oracles/deployments/**
      - silo-oracles/broadcast/**
      - silo-vaults/deployments/**
      - silo-vaults/broadcast/**
      - scripts/check_deployments_verified_on_explorer.py
      - scripts/merge_verification_reports.py
      - .github/workflows/check-deployments-verified-on-explorer.yml

env:
  ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

jobs:
  verify:
    name: Verify (${{ matrix.chain }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chain:
          - arbitrum_one
          - avalanche
          - base
          - bnb
          - injective
          - mainnet
          - optimism
          - okx
          - sonic
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check verification (${{ matrix.chain }})
        run: |
          python3 scripts/check_deployments_verified_on_explorer.py \
            --chain ${{ matrix.chain }} \
            --no-fail \
            --output-json-file verification_${{ matrix.chain }}.json
        continue-on-error: true

      - name: Ensure artifact exists (for failed runs)
        if: failure() && hashFiles(format('verification_{0}.json', matrix.chain)) == ''
        run: echo '{"sections":[]}' > verification_${{ matrix.chain }}.json

      - name: Upload verification result
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verification-${{ matrix.chain }}
          path: verification_${{ matrix.chain }}.json

  aggregate-and-comment:
    name: Aggregate and comment
    runs-on: ubuntu-latest
    needs: [verify]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download verification artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: verification-*
          path: verification-artifacts

      - name: Merge reports and generate comment
        run: |
          python3 scripts/merge_verification_reports.py \
            --artifacts-dir verification-artifacts \
            --pr-comment-from-gh \
            -o pr_comment.md
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Post or update PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: deployment-verification
          path: pr_comment.md
