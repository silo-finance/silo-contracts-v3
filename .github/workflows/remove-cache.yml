name: Clear GitHub Actions Caches

on:
  # Manual trigger
  workflow_dispatch:
  # Also run automatically on every PR to prune old/unused caches
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  clear-action-caches:
    runs-on: ubuntu-latest
    steps:
      - name: List all caches
        id: list_caches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching cache list for repository: ${{ github.repository }}"
          curl -s -H "Accept: application/vnd.github+json" \
               -H "Authorization: token $GITHUB_TOKEN" \
               "https://api.github.com/repos/${{ github.repository }}/actions/caches" > caches.json
          echo "Caches fetched. Summary:"
          jq '.total_count as $n | "Total caches: \($n)"' caches.json || cat caches.json

      - name: Delete caches older than 30 days (by last access or creation time)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Compute cutoff timestamp (30 days ago) in ISO 8601 format
          CUTOFF_DATE=$(date -u -d "30 days ago" +"%Y-%m-%dT%H:%M:%SZ")
          echo "Cutoff date for cache deletion: $CUTOFF_DATE"

          echo "Selecting caches with last_accessed_at/created_at older than cutoff..."
          # Extract IDs (and echo info) for caches older than cutoff.
          # We compare ISO strings lexicographically which is safe for this format.
          jq -r --arg cutoff "$CUTOFF_DATE" '
            .actions_caches[]
            | . as $c
            | ($c.last_accessed_at // $c.created_at) as $access
            | select($access < $cutoff)
            | "\($c.id) \t key=\($c.key) \t last_accessed=\($c.last_accessed_at // "null") \t created_at=\($c.created_at)"
          ' caches.json > old_caches.txt || echo "No caches to consider."

          if [ ! -s old_caches.txt ]; then
            echo "No caches older than 30 days found. Nothing to delete."
            exit 0
          fi

          echo "Caches marked for deletion (older than 30 days):"
          cat old_caches.txt

          CACHE_IDS=$(cut -f1 -d' ' old_caches.txt)
          
          if [ -z "$CACHE_IDS" ]; then
            echo "No cache IDs extracted to delete."
          else
            for cache_id in $CACHE_IDS; do
              echo "Deleting cache with ID: $cache_id"
              curl -s -X DELETE -H "Accept: application/vnd.github+json" \
                   -H "Authorization: token $GITHUB_TOKEN" \
                   "https://api.github.com/repos/${{ github.repository }}/actions/caches/$cache_id"
            done
            echo "Finished deleting caches."
          fi
