# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: CORE Quality Test

env:
    RPC_MAINNET: ${{ secrets.RPC_MAINNET }}
    RPC_ARBITRUM: ${{ secrets.RPC_ARBITRUM }}
    RPC_OPTIMISM: ${{ secrets.RPC_OPTIMISM }}
    RPC_ANVIL: ${{ secrets.RPC_ANVIL }}
    RPC_SONIC: ${{ secrets.RPC_SONIC }}
    RPC_AVALANCHE: ${{ secrets.RPC_AVALANCHE }}
    RPC_INK: ${{ secrets.RPC_INK }}
    PRIVATE_KEY: ${{ secrets.ANVIL_PRIVATE_KEY }}
    VERIFIER_URL_SONIC: ${{ secrets.VERIFIER_URL_SONIC }}
    VERIFIER_API_KEY_SONIC: ${{ secrets.VERIFIER_API_KEY_SONIC }}
    AGGREGATOR: "1INCH" # because it is available on all blockchains

on:
    push:
        branches: [ master, develop ]
        paths:
            - silo-core/**/*.sol
            - silo-core/**/*.ts
            - silo-core/**/*.js
            - silo-core/**/*.json
            - silo-oracles/**/*.sol
            - silo-oracles/**/*.ts
            - silo-oracles/**/*.js
            - silo-oracles/**/*.json
            - package.json
            - yarn.lock
            - gitmodules/*
            - .gitmodules
            - .github/workflows/silo-core.yml

    pull_request:
        paths:
            - silo-core/**/*.sol
            - silo-core/**/*.ts
            - silo-core/**/*.js
            - silo-core/**/*.json
            - silo-oracles/**/*.sol
            - silo-oracles/**/*.ts
            - silo-oracles/**/*.js
            - silo-oracles/**/*.json
            - package.json
            - yarn.lock
            - gitmodules/*
            - .gitmodules
            - .github/workflows/silo-core.yml

jobs:
    linters:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout sources
                uses: actions/checkout@v3
                
            # Cache all git submodules (large gitmodules/* tree and .git/modules) to speed up CI.
            # Keyed only by .gitmodules so cache can be reused across commits; git will fetch deltas if submodule refs change.
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    path: |
                        gitmodules
                        .git/modules
                    key: gitmodules-v1-${{ hashFiles('.gitmodules') }}
                    restore-keys: |
                        gitmodules-v1-

            -   name: Init git submodules (uses cached clones when available)
                run: |
                    git submodule sync --recursive
                    git submodule update --init --recursive

            -   name: Set up Node.js
                uses: actions/setup-node@v3
                with:
                    node-version: 20.x
                    cache: 'yarn'

            -   run: yarn install

            -   name: Solidity Lint
                run: yarn workspace silo-core lint:sol

            -   name: Solidity Tests Lint
                run: yarn workspace silo-core lint-tests:sol

            -   name: Solidity Deploy Scripts Lint
                run: yarn workspace silo-core lint-deploy:sol

            -   name: Solidity Common Lint
                run: yarn workspace silo-core lint-common:sol

    fast-tests:
        runs-on: ubuntu-latest

        steps:
            -   uses: actions/checkout@v3
                
            # Cache all git submodules (large gitmodules/* tree and .git/modules) to speed up CI.
            # Keyed only by .gitmodules so cache can be reused across commits; git will fetch deltas if submodule refs change.
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    path: |
                        gitmodules
                        .git/modules
                    key: gitmodules-v1-${{ hashFiles('.gitmodules') }}
                    restore-keys: |
                        gitmodules-v1-

            -   name: Init git submodules (uses cached clones when available)
                run: |
                    git submodule sync --recursive
                    git submodule update --init --recursive

            -   name: Install Foundry
                uses: foundry-rs/foundry-toolchain@v1
                with:
                    version: v1.2.3

            -   name: Build silo foundry utils
                working-directory: ./gitmodules/silo-foundry-utils
                run: |
                    cargo build --release
                    cp target/release/silo-foundry-utils ../../silo-foundry-utils
                    ../../silo-foundry-utils --version
            
            -   name: check contract sizes
                run: |
                    forge --version
                    FOUNDRY_PROFILE=core forge build --sizes

            # Foundry RPC cache path is NOT configurable (foundry.toml cache_path = build artifacts only).
            # Forge always writes to $HOME/.foundry/cache/rpc. On ubuntu-latest HOME=/home/runner, so we cache that path explicitly.
            -   name: Cache Foundry RPC (all chains and blocks)
                uses: actions/cache@v4
                with:
                    path: ~/.foundry/cache/rpc
                    key: foundry-rpc-${{ runner.os }}-v1
                    restore-keys: |
                        foundry-rpc-${{ runner.os }}-

            -   name: Show Foundry RPC cache
                run: |
                    forge cache ls 2>&1 || echo "No cache yet (first fork test will create it)"

            -   name: all fast test
                run: FOUNDRY_PROFILE=core_test forge test --no-match-test "_skip_" --nmc "MaxBorrow|MaxLiquidationTest|MaxLiquidationBadDebt|PreviewTest|PreviewDepositTest|PreviewMintTest|SiloLensCompatibilityTest|NewMarketTest|SiloDeployerIntegrationTest|BackwardsCompatibleGaugeLikeTest|DefaultingLiquidation|CryticToFoundry|ERC4626ComplianceTest|PartialLiquidation1weiTest|InterestOverflowTest|MaxWithdrawAndFractionsTest|LiquidationHelperTest|MaxLiquidationWithChunksTest|MaxLiquidationDustWithChunksTest|MaxWithdrawTest|MaxLiquidationLTV100FullWithChunksTest" --ffi -vv

    slow-contracts-tests:
        strategy:
            matrix:
                match-contract: [
                    ERC4626ComplianceTest,
                    PartialLiquidation1weiTest|InterestOverflowTest,
                    MaxWithdrawAndFractionsTest|LiquidationHelperTest|MaxLiquidationWithChunksTest|MaxLiquidationDustWithChunksTest|MaxWithdrawTest|MaxLiquidationLTV100FullWithChunksTest,
                    MaxBorrow,
                    MaxDepositTest,
                    MaxLiquidationBadDebt,
                    PreviewTest,
                    PreviewDepositTest,
                    PreviewMintTest
               ]

        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v3
                
            # Cache all git submodules (large gitmodules/* tree and .git/modules) to speed up CI.
            # Keyed only by .gitmodules so cache can be reused across commits; git will fetch deltas if submodule refs change.
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    path: |
                        gitmodules
                        .git/modules
                    key: gitmodules-v1-${{ hashFiles('.gitmodules') }}
                    restore-keys: |
                        gitmodules-v1-

            -   name: Init git submodules (uses cached clones when available)
                run: |
                    git submodule sync --recursive
                    git submodule update --init --recursive

            -   name: Install Foundry
                uses: foundry-rs/foundry-toolchain@v1
                with:
                    version: v1.2.3

            -   name: Build silo foundry utils
                working-directory: ./gitmodules/silo-foundry-utils
                run: |
                    cargo build --release
                    cp target/release/silo-foundry-utils ../../silo-foundry-utils
                    ../../silo-foundry-utils --version

            # Foundry RPC cache path is NOT configurable (foundry.toml cache_path = build artifacts only).
            # Forge always writes to $HOME/.foundry/cache/rpc. On ubuntu-latest HOME=/home/runner, so we cache that path explicitly.
            -   name: Cache Foundry RPC (all chains and blocks)
                uses: actions/cache@v4
                with:
                    path: ~/.foundry/cache/rpc
                    key: foundry-rpc-${{ runner.os }}-v1
                    restore-keys: |
                        foundry-rpc-${{ runner.os }}-

            -   name: ${{ matrix.match-contract }}
                run: FOUNDRY_PROFILE=core_test forge test --no-match-test "_skip_" --mc "${{ matrix.match-contract }}" --ffi -vv

    MaxLiquidationTest:
        strategy:
            matrix:
                match-test: [
                    test_maxLiquidation_noDebt,
                    test_maxLiquidation_partial_sTokens,
                    test_maxLiquidation_partial_tokens
               ]

        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v3
                
            # Cache all git submodules (large gitmodules/* tree and .git/modules) to speed up CI.
            # Keyed only by .gitmodules so cache can be reused across commits; git will fetch deltas if submodule refs change.
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    path: |
                        gitmodules
                        .git/modules
                    key: gitmodules-v1-${{ hashFiles('.gitmodules') }}
                    restore-keys: |
                        gitmodules-v1-

            -   name: Init git submodules (uses cached clones when available)
                run: |
                    git submodule sync --recursive
                    git submodule update --init --recursive

            -   name: Install Foundry
                uses: foundry-rs/foundry-toolchain@v1
                with:
                    version: v1.2.3

            -   name: Build silo foundry utils
                working-directory: ./gitmodules/silo-foundry-utils
                run: |
                    cargo build --release
                    cp target/release/silo-foundry-utils ../../silo-foundry-utils
                    ../../silo-foundry-utils --version

            # Foundry RPC cache path is NOT configurable (foundry.toml cache_path = build artifacts only).
            # Forge always writes to $HOME/.foundry/cache/rpc. On ubuntu-latest HOME=/home/runner, so we cache that path explicitly.
            -   name: Cache Foundry RPC (all chains and blocks)
                uses: actions/cache@v4
                with:
                    path: ~/.foundry/cache/rpc
                    key: foundry-rpc-${{ runner.os }}-v1
                    restore-keys: |
                        foundry-rpc-${{ runner.os }}-

            -   name: ${{ matrix.match-test }}
                run: FOUNDRY_PROFILE=core_test forge test --no-match-test "_skip_" --mc MaxLiquidationTest --mt ${{ matrix.match-test }} --ffi -vv
            
    DefaultingLiquidation:
        strategy:
            matrix:
                match-test: [
                    DefaultingLiquidationBorrowable0Test --mt long_fuzz,
                    DefaultingLiquidationBorrowable0Test --mt fuzz_limit --fuzz-runs 10,
                    DefaultingLiquidationBorrowable0Test --nmt "long_fuzz|fuzz_limit",
                    DefaultingLiquidationBorrowable1Test --mt long_fuzz,
                    DefaultingLiquidationBorrowable1Test --mt fuzz_limit --fuzz-runs 10,
                    DefaultingLiquidationBorrowable1Test --nmt "long_fuzz|fuzz_limit",
                    DefaultingLiquidation --nmc DefaultingLiquidationBorrowable
               ]

        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v3
                
            # Cache all git submodules (large gitmodules/* tree and .git/modules) to speed up CI.
            # Keyed only by .gitmodules so cache can be reused across commits; git will fetch deltas if submodule refs change.
            -   name: Cache git submodules
                uses: actions/cache@v4
                with:
                    path: |
                        gitmodules
                        .git/modules
                    key: gitmodules-v1-${{ hashFiles('.gitmodules') }}
                    restore-keys: |
                        gitmodules-v1-

            -   name: Init git submodules (uses cached clones when available)
                run: |
                    git submodule sync --recursive
                    git submodule update --init --recursive

            -   name: Install Foundry
                uses: foundry-rs/foundry-toolchain@v1
                with:
                    version: v1.2.3

            -   name: Build silo foundry utils
                working-directory: ./gitmodules/silo-foundry-utils
                run: |
                    cargo build --release
                    cp target/release/silo-foundry-utils ../../silo-foundry-utils
                    ../../silo-foundry-utils --version

            # Foundry RPC cache path is NOT configurable (foundry.toml cache_path = build artifacts only).
            # Forge always writes to $HOME/.foundry/cache/rpc. On ubuntu-latest HOME=/home/runner, so we cache that path explicitly.
            -   name: Cache Foundry RPC (all chains and blocks)
                uses: actions/cache@v4
                with:
                    path: ~/.foundry/cache/rpc
                    key: foundry-rpc-${{ runner.os }}-v1
                    restore-keys: |
                        foundry-rpc-${{ runner.os }}-

            -   name: ${{ matrix.match-test }}
                run: FOUNDRY_PROFILE=core_test forge test --mc ${{ matrix.match-test }} --ffi -vv
