name: SiloFactory Silo ID Check

on:
  pull_request:
    paths:
      - 'silo-core/contracts/SiloFactory.sol'
      - '.github/workflows/silo-factory-silo-id-check.yml'

jobs:
  check-silo-id-change:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compare _siloId initializer
        id: compare
        run: |
          set -euo pipefail

          FILE="silo-core/contracts/SiloFactory.sol"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"

          OLD_LINE="$(git show "${BASE_SHA}:${FILE}" 2>/dev/null | grep -E '^[[:space:]]*_siloId[[:space:]]*=[[:space:]]*[0-9_]+[[:space:]]*;' | head -n1 || true)"
          NEW_LINE="$(grep -E '^[[:space:]]*_siloId[[:space:]]*=[[:space:]]*[0-9_]+[[:space:]]*;' "${FILE}" | head -n1 || true)"

          if [ -z "${OLD_LINE}" ] || [ -z "${NEW_LINE}" ]; then
            echo "::error title=Cannot parse _siloId::Could not find '_siloId = <number>;' in either the base or current version."
            {
              echo "status=fail"
              echo "old=unknown"
              echo "new=unknown"
            } >> "$GITHUB_OUTPUT"
            exit 1
          fi

          OLD_ID="$(echo "${OLD_LINE}" | sed -E 's/.*=[[:space:]]*([0-9_]+)[[:space:]]*;.*/\1/' | tr -d '_')"
          NEW_ID="$(echo "${NEW_LINE}" | sed -E 's/.*=[[:space:]]*([0-9_]+)[[:space:]]*;.*/\1/' | tr -d '_')"

          echo "Old _siloId: ${OLD_ID}"
          echo "New _siloId: ${NEW_ID}"

          {
            echo "old=${OLD_ID}"
            echo "new=${NEW_ID}"
          } >> "$GITHUB_OUTPUT"

          if [ "${OLD_ID}" = "${NEW_ID}" ]; then
            echo "::error title=Silo ID unchanged::SiloFactory was changed, but the initial _siloId remained unchanged (${OLD_ID})."
            echo "status=fail" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "status=ok" >> "$GITHUB_OUTPUT"

