name: Silo Implementations Address Check

on:
  push:
    branches: [ master, develop ]
    paths:
      - 'silo-core/deployments/**/Silo.sol.json'
      - 'silo-core/deploy/silo/_siloImplementations.json'
      - '.github/workflows/silo-implementations-check.yml'
  pull_request:
    paths:
      - 'silo-core/deployments/**/Silo.sol.json'
      - 'silo-core/deploy/silo/_siloImplementations.json'
      - '.github/workflows/silo-implementations-check.yml'

jobs:
  check-silo-implementations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate deployed Silo addresses in implementations file
        run: |
          set -euo pipefail

          DEPLOYMENTS_GLOB="silo-core/deployments/*/Silo.sol.json"
          IMPLEMENTATIONS_FILE="silo-core/deploy/silo/_siloImplementations.json"
          MISSING_FOUND=0

          for deployment_file in $DEPLOYMENTS_GLOB; do
            chain="$(basename "$(dirname "$deployment_file")")"
            deployed_address="$(jq -r '.address // empty' "$deployment_file")"

            if [ -z "$deployed_address" ]; then
              echo "::error title=Missing deployed address::No .address in $deployment_file (blockchain: $chain)"
              MISSING_FOUND=1
              continue
            fi

            is_present="$(jq -r --arg chain "$chain" --arg deployed_address "$deployed_address" '
              ((.[$chain] // [])
                | map(.implementation | ascii_downcase)
                | index($deployed_address | ascii_downcase)
              ) != null
            ' "$IMPLEMENTATIONS_FILE")"

            if [ "$is_present" != "true" ]; then
              echo "::error title=Missing Silo implementation::Missing blockchain '$chain' with address '$deployed_address' in file $IMPLEMENTATIONS_FILE"
              MISSING_FOUND=1
            fi
          done

          if [ "$MISSING_FOUND" -eq 1 ]; then
            echo "❌ Found missing Silo implementation entries."
            exit 1
          fi

          echo "✅ All deployed Silo addresses are present in $IMPLEMENTATIONS_FILE."
